<VirtualHost *:80>
	ServerName {{ ejbca_httpserver_name }}.{{ ejbca_httpserver_domain }}
        DocumentRoot /var/www/

        # Proxy requests to EJBCA instances (only one on local machine configured)
        <Proxy balancer://mycluster-kerb>
                BalancerMember ajp://localhost:8009/ejbca/
        </Proxy>
        ProxyPass / balancer://mycluster-kerb/

        RewriteEngine   On
        # Redirect all but the CRL Distribution Point, OCSP and Helthcheck to HTTPS
        RewriteCond     %{THE_REQUEST} !(/publicweb/webdist/certdist.*cmd=crl|/publicweb/status/)
        RewriteRule     ^(.*)$ https://%{SERVER_NAME}$1 [L,R]
        # Treat reqeusts to / and /ejbca/ as the same. Required by EJBCA's Admin Web.
        RewriteCond     %{THE_REQUEST}  /ejbca/
        RewriteRule     ^/ejbca/(.*)$ /$1 [PT]

        # Configure log
        LogLevel warn
        ErrorLog /var/log/httpd/ejbca_error.log
        CustomLog /var/log/httpd/ejbca_access.log combined
</VirtualHost>


<VirtualHost *:443>
	ServerName {{ ejbca_httpserver_name }}.{{ ejbca_httpserver_domain }}
        DocumentRoot /var/www/

        RewriteEngine   On
        # Treat requests to / and /ejbca/ as the same. Required by EJBCA's Admin Web.
        RewriteCond     %{THE_REQUEST}  /ejbca/
        RewriteRule     ^/ejbca/(.*)$ /$1 [PT]

        # Configure secure SSL for this server using SSL certificate generated by EJBCA
        SSLEngine on
        SSLCipherSuite HIGH
        SSLProtocol all -SSLv2
        SSLCertificateFile /etc/httpd/conf/ssl/{{ ejbca_httpserver_name }}.{{ ejbca_httpserver_domain }}.pem
        SSLCertificateKeyFile /etc/httpd/conf/ssl/{{ ejbca_httpserver_name }}.{{ ejbca_httpserver_domain }}-Key.pem
        SSLCACertificateFile /etc/httpd/conf/ssl/{{ ejbca_httpserver_name }}.{{ ejbca_httpserver_domain }}-CA.pem

        # Require Client SSL certificate  for the Admin GUI
        <Location /adminweb>
                SSLVerifyClient require
                SSLVerifyDepth 1
        </Location>

        # Proxy requests to EJBCA instances (only one on local machine configured)
        <Proxy balancer://mycluster-kerb>
                BalancerMember ajp://localhost:8009/ejbca/
        </Proxy>
        ProxyPass / balancer://mycluster-kerb/

        # Configure log
        LogLevel warn
        ErrorLog /var/log/httpd/ejbca_ssl_error.log
        CustomLog /var/log/httpd/ejbca_ssl_access.log combined
</VirtualHost>
